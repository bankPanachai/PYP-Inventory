<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Crew Requisition System</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@400;700;800&display=swap" rel="stylesheet">
  <style>
    :root { --primary: #2563eb; --bg: #f8fafc; }
    body { background-color: var(--bg); font-family: 'Sarabun', sans-serif; padding-bottom: 30px; }
    .card-main { background: white; border-radius: 20px; box-shadow: 0 4px 20px rgba(0,0,0,0.08); padding: 25px; margin-top: 20px; border: none; }
    .item-card { border: 1.5px solid #e2e8f0; border-radius: 16px; padding: 18px; margin-bottom: 12px; }
    .item-card.has-val { border-color: var(--primary); background: #eff6ff; }
    .btn-step { width: 45px; height: 45px; border-radius: 12px; border: 1px solid #ddd; background: white; font-weight: bold; display: flex; align-items: center; justify-content: center; cursor: pointer; }
    .qty-val { font-size: 22px; font-weight: 800; min-width: 35px; text-align: center; }
    .hidden { display: none; }
    .profile-banner { background: #eef2ff; border-radius: 15px; padding: 15px; border: 1px solid #c3dafe; margin-bottom: 20px; }
  </style>
</head>
<body>

<div class="container" style="max-width: 480px;">
  <div class="card-main">
    
    <div id="step1">
      <h5 class="fw-bold mb-3">üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô</h5>
      <input type="text" id="searchInput" class="form-control p-3 mb-3" style="border-radius:12px" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ä‡∏∑‡πà‡∏≠ ‡∏´‡∏£‡∏∑‡∏≠ ID...">
      <button class="btn btn-primary w-100 p-3 fw-bold shadow-sm" onclick="searchCrew()">‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
      <div id="staffList" class="mt-3"></div>
    </div>

    <div id="stepConfirm" class="hidden">
      <button class="btn btn-sm text-muted mb-3" onclick="switchStep('step1')">‚Üê ‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤</button>
      <div class="profile-banner text-center shadow-sm">
        <div class="fs-5 fw-bold text-primary" id="cName"></div>
        <div class="text-muted small">StaffID: <span id="cIpn"></span></div>
      </div>
      <label class="fw-bold small mb-2">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á (Position)</label>
      <select id="rankSelector" class="form-select form-select-lg mb-4" style="border-radius:12px"></select>
      <button class="btn btn-primary w-100 p-3 fw-bold" onclick="proceedToItems()">‡∏ñ‡∏±‡∏î‡πÑ‡∏õ ‚Üí</button>
    </div>

    <div id="stepItems" class="hidden">
      <button class="btn btn-sm text-muted mb-3" onclick="switchStep('stepConfirm')">‚Üê ‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö</button>
      <h6 class="fw-bold mb-3">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÅ‡∏•‡∏∞‡πÑ‡∏ã‡∏™‡πå (‡∏£‡∏≠‡∏á‡πÄ‡∏ó‡πâ‡∏≤‡πÄ‡∏ö‡∏¥‡∏Å‡πÑ‡∏î‡πâ 2 ‡∏Ñ‡∏π‡πà)</h6>
      <div id="itemList"></div>
      <button class="btn btn-primary w-100 p-3 fw-bold mt-3" onclick="goToSummary()">‡∏î‡∏π‡∏™‡∏£‡∏∏‡∏õ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ ‚Üí</button>
    </div>

    <div id="stepSummary" class="hidden">
      <button class="btn btn-sm text-muted mb-3" onclick="switchStep('stepItems')">‚Üê ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</button>
      <h5 class="fw-bold text-center mb-4">‡∏™‡∏£‡∏∏‡∏õ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡πÄ‡∏ö‡∏¥‡∏Å</h5>
      <div class="p-3 mb-4 bg-light rounded-3 border">
        <div class="fw-bold text-primary" id="sName"></div>
        <div class="small text-muted" id="sInfo"></div>
        <hr>
        <div id="summaryContent"></div>
      </div>
      <button id="btnSubmit" class="btn btn-success w-100 p-3 fw-bold shadow" onclick="confirmSubmit()">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
    </div>

    <div id="stepSuccess" class="hidden text-center py-5">
      <div class="display-3 text-success mb-3">‚úî</div>
      <h4 class="fw-bold">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à</h4>
      <button class="btn btn-primary w-100 mt-4" onclick="location.reload()">‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å</button>
    </div>

  </div>
</div>

<script>
  // *** ‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç: ‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏ä‡πâ URL ‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡∏à‡∏≤‡∏Å‡∏Å‡∏≤‡∏£ Deploy ‡πÄ‡∏õ‡πá‡∏ô "New Version" ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô ***
  const API_URL = "https://script.google.com/macros/s/AKfycbzNT9xSWH_AFY2Fqe6HTde89-BIOmDsS_M18CEqOW3m9EPZeWjKS9L1SEDECvLHDc7FdA/exec"; 

  let crew = {};
  let itemsData = [];
  const shoeMap = { "4":"38", "5":"39", "6":"40", "7":"41", "8":"42", "9":"43", "10":"44", "11":"45", "12":"46" };

  window.onload = async () => {
    const ranks = await apiFetch({action: 'getRanks'});
    const sel = document.getElementById('rankSelector');
    sel.innerHTML = '<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á --</option>';
    ranks.forEach(r => sel.innerHTML += `<option value="${r}">${r}</option>`);
  };

  async function searchCrew() {
    const q = document.getElementById('searchInput').value;
    if(!q) return;
    const res = await apiFetch({action: 'searchStaff', query: q});
    let html = '';
    res.data.forEach(s => {
      html += `<div class="card p-3 mb-2 shadow-sm border-0" style="cursor:pointer; background:#f1f5f9" onclick="selectCrew('${s.ipn}', '${s.name}')">
                <div class="fw-bold text-primary">${s.name}</div>
                <div class="small text-muted">StaffID: ${s.ipn}</div>
              </div>`;
    });
    document.getElementById('staffList').innerHTML = html || '‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô';
  }

  function selectCrew(ipn, name) {
    crew = { ipn, name };
    document.getElementById('cName').innerText = name;
    document.getElementById('cIpn').innerText = ipn;
    switchStep('stepConfirm');
  }

  async function proceedToItems() {
    crew.rank = document.getElementById('rankSelector').value;
    if(!crew.rank) return alert("‡πÇ‡∏õ‡∏£‡∏î‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á");
    itemsData = await apiFetch({action: 'getItems', rank: crew.rank});
    renderItems();
    switchStep('stepItems');
  }

  function renderItems() {
    document.getElementById('itemList').innerHTML = itemsData.map((item, i) => {
      // ‡∏õ‡∏£‡∏±‡∏ö‡πÉ‡∏´‡πâ Safety Shoes ‡∏°‡∏µ‡∏•‡∏¥‡∏°‡∏¥‡∏ï 2 ‡∏´‡∏ô‡πà‡∏ß‡∏¢‡πÄ‡∏™‡∏°‡∏≠
      let limit = item.name.toLowerCase().includes('shoe') ? 2 : item.limit;
      return `
      <div class="item-card shadow-sm" id="box_${i}">
        <div class="d-flex justify-content-between align-items-center">
          <div class="fw-bold">${item.name} <br><small class="text-muted">‡∏•‡∏¥‡∏°‡∏¥‡∏ï: ${limit} ‡∏´‡∏ô‡πà‡∏ß‡∏¢</small></div>
          <div class="qty-box d-flex align-items-center gap-2">
            <div class="btn-step" onclick="changeQty(${i}, -1, ${limit})">-</div>
            <div class="qty-val" id="q_${i}">0</div>
            <div class="btn-step" onclick="changeQty(${i}, 1, ${limit})">+</div>
          </div>
        </div>
        ${item.sizes.length > 0 ? `
          <select class="form-select mt-2 hidden" id="s_${i}" style="border-radius:10px">
            <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ã‡∏™‡πå --</option>
            ${item.sizes.map(s => `<option value="${s}">Size ${s} / EU ${shoeMap[s] || '-'}</option>`).join('')}
          </select>` : ''}
      </div>`;
    }).join('');
  }

  function changeQty(i, delta, limit) {
    let q = parseInt(document.getElementById('q_'+i).innerText) + delta;
    if (q < 0) q = 0; if (q > limit) q = limit;
    document.getElementById('q_'+i).innerText = q;
    const box = document.getElementById('box_'+i);
    const sz = document.getElementById('s_'+i);
    if(q > 0) {
      box.classList.add('has-val');
      if(sz) sz.classList.remove('hidden');
    } else {
      box.classList.remove('has-val');
      if(sz) { sz.classList.add('hidden'); sz.value = ""; }
    }
  }

  function goToSummary() {
    let sel = []; let err = false;
    itemsData.forEach((item, i) => {
      const q = parseInt(document.getElementById('q_'+i).innerText);
      if(q > 0) {
        const szVal = document.getElementById('s_'+i) ? document.getElementById('s_'+i).value : "";
        if(document.getElementById('s_'+i) && !szVal) {
          document.getElementById('box_'+i).style.borderColor = 'red'; err = true;
        } else {
          document.getElementById('box_'+i).style.borderColor = '';
          const szLabel = szVal ? `Size ${szVal} / EU ${shoeMap[szVal]}` : "-";
          sel.push({ itemName: item.name, qty: q, size: szLabel });
        }
      }
    });
    if(err) return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ã‡∏™‡πå‡∏Ç‡∏≠‡∏á‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£");
    
    crew.selected = sel;
    document.getElementById('sName').innerText = crew.name;
    document.getElementById('sInfo').innerText = `StaffID: ${crew.ipn} | Position: ${crew.rank}`;
    document.getElementById('summaryContent').innerHTML = sel.map(s => `
      <div class="mb-2 p-2 bg-white border rounded">
        <b>‚Ä¢ ${s.itemName}</b><br>
        <span class="small text-muted">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô: ${s.qty} ‡∏´‡∏ô‡πà‡∏ß‡∏¢ | ‡πÑ‡∏ã‡∏™‡πå: ${s.size}</span>
      </div>`).join('') || '<div class="text-danger">‡πÑ‡∏°‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏±‡∏ö‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå</div>';
    switchStep('stepSummary');
  }

  async function confirmSubmit() {
    const btn = document.getElementById('btnSubmit');
    btn.disabled = true; btn.innerText = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...";
    try {
      await fetch(API_URL, {
        method: 'POST', mode: 'no-cors',
        body: JSON.stringify({ ipn: crew.ipn, name: crew.name, rank: crew.rank, items: crew.selected })
      });
      switchStep('stepSuccess');
    } catch(e) { alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å"); btn.disabled = false; }
  }

  function apiFetch(p) {
    return new Promise(res => {
      const cb = 'callback_' + Math.round(1000000 * Math.random());
      window[cb] = (d) => { res(d); delete window[cb]; };
      const s = document.createElement('script');
      s.src = API_URL + "?" + new URLSearchParams({...p, callback: cb});
      document.body.appendChild(s);
    });
  }

  function switchStep(id) {
    ['step1', 'stepConfirm', 'stepItems', 'stepSummary', 'stepSuccess'].forEach(s => document.getElementById(s).classList.add('hidden'));
    document.getElementById(id).classList.remove('hidden');
    window.scrollTo(0,0);
  }
</script>
</body>
</html>
