<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Crew Gear Requisition</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@400;600;800&display=swap" rel="stylesheet">
  <style>
    :root { --primary: #2563eb; --bg: #f8fafc; }
    body { background-color: var(--bg); font-family: 'Sarabun', sans-serif; -webkit-tap-highlight-color: transparent; padding-bottom: 30px; }
    .card-main { background: white; border-radius: 20px; box-shadow: 0 4px 25px rgba(0,0,0,0.1); padding: 25px; border: none; margin-top: 20px; }
    
    .btn-step { width: 45px; height: 45px; border-radius: 12px; border: 1px solid #ddd; background: #fff; font-size: 24px; font-weight: bold; display: flex; align-items: center; justify-content: center; cursor: pointer; }
    .btn-step:active { background: #f1f5f9; transform: scale(0.9); }
    .qty-val { font-size: 22px; font-weight: 800; min-width: 35px; text-align: center; }

    .item-card { border: 1.5px solid #e2e8f0; border-radius: 16px; padding: 18px; margin-bottom: 15px; }
    .item-card.has-val { border-color: var(--primary); background-color: #eff6ff; }
    .item-card.error { border-color: #ef4444; background: #fef2f2; }

    .staff-row { border: 1px solid #e2e8f0; border-radius: 12px; padding: 15px; margin-bottom: 10px; cursor: pointer; background: #fff; }
    .role-btn { border: 2px solid #e2e8f0; border-radius: 15px; padding: 15px; text-align: center; cursor: pointer; font-weight: 800; background: white; }
    .role-btn.active { border-color: var(--primary); background-color: var(--primary); color: white; }
    
    .hidden { display: none; }
    .btn-main { border-radius: 15px; padding: 16px; font-weight: 800; font-size: 18px; }
    .summary-item { background: #f8fafc; border-radius: 12px; padding: 15px; margin-bottom: 10px; border: 1px solid #e2e8f0; }
    .profile-banner { background: #eef2ff; border-radius: 15px; padding: 15px; border: 1px solid #c3dafe; }
  </style>
</head>
<body>

<div class="container" style="max-width: 500px;">
  <div class="card-main">
    
    <div id="step1">
      <h4 class="fw-bold mb-3 text-center">üö¢ ‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏ö‡∏¥‡∏Å‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå</h4>
      <div class="input-group mb-4 shadow-sm" style="border-radius: 15px; overflow: hidden;">
        <input type="text" id="searchInput" class="form-control p-3 border-0" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ä‡∏∑‡πà‡∏≠‡∏´‡∏£‡∏∑‡∏≠ StaffID...">
        <button class="btn btn-primary px-4" onclick="searchCrew()">‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤</button>
      </div>
      <div id="staffList"></div>
    </div>

    <div id="stepConfirmName" class="hidden">
      <button class="btn btn-sm text-muted mb-3" onclick="switchStep('step1')">‚Üê ‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤</button>
      <div class="profile-banner text-center mb-4">
        <div class="fs-4 fw-bold text-primary" id="confirmingName"></div>
        <div class="text-muted">StaffID: <span id="confirmingIpn"></span></div>
      </div>
      <div class="mb-4">
        <label class="fw-bold mb-2 small text-muted">‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á (Position)</label>
        <select class="form-select form-select-lg" id="rankSelector" onchange="checkSpecialRank()" style="border-radius: 12px;"></select>
      </div>
      <div id="specialRoleArea" class="hidden mb-4">
        <div class="row g-2">
          <div class="col-6"><div class="role-btn" id="roleBtnNormal" onclick="selectRole('normal')"></div></div>
          <div class="col-6"><div class="role-btn" id="roleBtnMSM" onclick="selectRole('MSM')">Duty MSM</div></div>
        </div>
      </div>
      <button class="btn btn-primary w-100 btn-main" onclick="proceedToItems()">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏ö‡∏¥‡∏Å ‚Üí</button>
    </div>

    <div id="step2" class="hidden">
      <button class="btn btn-sm text-muted mb-3" onclick="switchStep('stepConfirmName')">‚Üê ‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö</button>
      <h5 class="fw-bold mb-4 text-center">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£</h5>
      <div id="itemList"></div>
      <button class="btn btn-primary w-100 btn-main mt-3" onclick="goToSummary()">‡∏î‡∏π‡∏™‡∏£‡∏∏‡∏õ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ ‚Üí</button>
    </div>

    <div id="step3" class="hidden">
      <button class="btn btn-sm text-muted mb-3" onclick="switchStep('step2')">‚Üê ‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
      <h5 class="fw-bold mb-3 text-center">‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡πà‡∏≠‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</h5>
      
      <div class="profile-banner mb-4">
        <div class="fw-bold text-primary" id="sumCrewName"></div>
        <div class="small text-muted">ID: <span id="sumCrewIpn"></span> | Pos: <span id="sumCrewRank"></span></div>
      </div>

      <div id="summaryContent" class="mb-4"></div>
      
      <button id="btnConfirm" class="btn btn-success w-100 btn-main shadow mb-2" onclick="confirmSubmit()">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á</button>
    </div>

    <div id="stepSuccess" class="hidden text-center py-5">
      <div class="display-1 text-success mb-3">‚úî</div>
      <h4 class="fw-bold">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢</h4>
      <button class="btn btn-primary btn-main px-5 mt-3" onclick="location.reload()">‡∏ó‡∏≥‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡∏°‡πà</button>
    </div>

  </div>
</div>

<script>
  // ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô URL ‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì
  const API_URL = "https://script.google.com/macros/s/AKfycbyQDX_gRWJ_7kaLZT7PqzNwVxyUmnkZk8By8VzIzqfbL7DLQdSTTZy40nZG9KQHdJnfRA/exec"; 

  let crew = {};
  let selectedDuty = "";
  let itemsData = [];
  const shoeMap = { "4": "38", "5": "39", "6": "40", "7": "41", "8": "42", "9": "43", "10": "44", "11": "45", "12": "46" };

  function apiFetch(params) {
    return new Promise((resolve, reject) => {
      const callbackName = 'jsonp_' + Math.round(100000 * Math.random());
      window[callbackName] = function(data) {
        delete window[callbackName];
        document.body.removeChild(script);
        resolve(data);
      };
      const url = new URL(API_URL);
      Object.keys(params).forEach(key => url.searchParams.append(key, params[key]));
      url.searchParams.append('callback', callbackName);
      const script = document.createElement('script');
      script.src = url.toString();
      script.onerror = () => reject(new Error('Network Error'));
      document.body.appendChild(script);
    });
  }

  window.onload = async () => {
    const ranks = await apiFetch({action: 'getRanks'});
    const sel = document.getElementById('rankSelector');
    sel.innerHTML = '<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á --</option>';
    ranks.forEach(r => sel.innerHTML += `<option value="${r}">${r}</option>`);
  };

  async function searchCrew() {
    const q = document.getElementById('searchInput').value;
    if(!q) return;
    document.getElementById('staffList').innerHTML = '<div class="text-center p-4">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤...</div>';
    const res = await apiFetch({action: 'searchStaff', query: q});
    let html = '';
    res.data.forEach(s => {
      html += `<div class="staff-row p-3 shadow-sm mb-2" onclick="showConfirmName('${s.ipn}', '${s.name}')">
                <div class="fw-bold text-primary">${s.name}</div>
                <div class="small text-muted">ID: ${s.ipn}</div>
              </div>`;
    });
    document.getElementById('staffList').innerHTML = html || '<div class="p-3 text-center">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</div>';
  }

  function showConfirmName(ipn, name) {
    crew = { ipn, name };
    document.getElementById('confirmingName').innerText = name;
    document.getElementById('confirmingIpn').innerText = ipn;
    switchStep('stepConfirmName');
  }

  function checkSpecialRank() {
    const r = document.getElementById('rankSelector').value;
    const area = document.getElementById('specialRoleArea');
    if (r === "OS" || r === "WPR") {
      area.classList.remove('hidden');
      document.getElementById('roleBtnNormal').innerText = "Duty " + r;
      document.getElementById('roleBtnNormal').dataset.val = r;
    } else {
      area.classList.add('hidden');
      selectedDuty = r;
    }
  }

  function selectRole(t) {
    document.querySelectorAll('.role-btn').forEach(b => b.classList.remove('active'));
    if (t === 'normal') {
      document.getElementById('roleBtnNormal').classList.add('active');
      selectedDuty = document.getElementById('roleBtnNormal').dataset.val;
    } else {
      document.getElementById('roleBtnMSM').classList.add('active');
      selectedDuty = "MSM";
    }
  }

  async function proceedToItems() {
    const rankVal = document.getElementById('rankSelector').value;
    if (!rankVal) return alert("‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏Å‡πà‡∏≠‡∏ô");
    if (!selectedDuty) selectedDuty = rankVal;
    crew.mainRank = rankVal;
    itemsData = await apiFetch({action: 'getItems', rank: selectedDuty});
    renderItems();
    switchStep('step2');
  }

  function renderItems() {
    const list = document.getElementById('itemList');
    list.innerHTML = itemsData.map((item, i) => `
      <div class="item-card shadow-sm" id="itemBox_${i}">
        <div class="d-flex justify-content-between align-items-center mb-2">
          <div class="fw-bold">${item.name} <br><small class="text-muted fw-normal">Max: ${item.limit}</small></div>
          <div class="qty-box d-flex align-items-center gap-3">
            <div class="btn-step" onclick="changeQty(${i}, -1)">-</div>
            <div class="qty-val" id="qtext_${i}">0</div>
            <div class="btn-step" onclick="changeQty(${i}, 1)">+</div>
          </div>
        </div>
        ${item.sizes.length > 0 ? `
          <select class="form-select mt-2 hidden" id="size_${i}">
            <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ã‡∏™‡πå --</option>
            ${item.sizes.map(s => `<option value="${s}">Size ${s} / EU ${shoeMap[s] || '-'}</option>`).join('')}
          </select>` : ''}
      </div>`).join('');
  }

  function changeQty(i, delta) {
    let val = parseInt(document.getElementById('qtext_'+i).innerText) + delta;
    if (val < 0) val = 0;
    if (val > itemsData[i].limit) val = itemsData[i].limit;
    document.getElementById('qtext_'+i).innerText = val;
    
    const box = document.getElementById('itemBox_'+i);
    const sz = document.getElementById('size_'+i);
    if (val > 0) {
      box.classList.add('has-val');
      if(sz) sz.classList.remove('hidden');
    } else {
      box.classList.remove('has-val');
      if(sz) { sz.classList.add('hidden'); sz.value = ""; }
    }
  }

  function goToSummary() {
    let sel = [];
    let err = false;
    itemsData.forEach((item, i) => {
      const q = parseInt(document.getElementById('qtext_'+i).innerText);
      if (q > 0) {
        const sz = document.getElementById('size_'+i) ? document.getElementById('size_'+i).value : "";
        if (document.getElementById('size_'+i) && !sz) {
          document.getElementById('itemBox_'+i).classList.add('error');
          err = true;
        } else {
          document.getElementById('itemBox_'+i).classList.remove('error');
          const sizeLabel = sz ? `Size ${sz} / EU ${shoeMap[sz]}` : "-";
          sel.push({ itemName: item.name, qty: q, size: sizeLabel });
        }
      }
    });
    if(err) return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ã‡∏™‡πå‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏ö‡∏¥‡∏Å");
    
    crew.selected = sel;
    document.getElementById('sumCrewName').innerText = crew.name;
    document.getElementById('sumCrewIpn').innerText = crew.ipn;
    document.getElementById('sumCrewRank').innerText = crew.mainRank;

    let html = sel.map(s => `
      <div class="summary-item">
        <div class="fw-bold text-dark">${s.itemName}</div>
        <div class="d-flex justify-content-between small text-muted">
          <span>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô: ${s.qty}</span>
          <span>‡πÑ‡∏ã‡∏™‡πå: ${s.size}</span>
        </div>
      </div>`).join('');
    document.getElementById('summaryContent').innerHTML = html || '<div class="alert alert-warning text-center"><b>‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</b><br>‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏∞‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ß‡πà‡∏≤‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏ö‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå</div>';
    switchStep('step3');
  }

  async function confirmSubmit() {
    const btn = document.getElementById('btnConfirm');
    btn.disabled = true; btn.innerText = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...";
    try {
      await fetch(API_URL, {
        method: 'POST',
        mode: 'no-cors',
        body: JSON.stringify({ ipn: crew.ipn, name: crew.name, rank: crew.mainRank, items: crew.selected })
      });
      switchStep('stepSuccess');
    } catch(e) { 
      alert("Error"); btn.disabled = false; btn.innerText = "‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á";
    }
  }

  function switchStep(id) {
    ['step1', 'stepConfirmName', 'step2', 'step3', 'stepSuccess'].forEach(s => document.getElementById(s).classList.add('hidden'));
    document.getElementById(id).classList.remove('hidden');
    window.scrollTo(0,0);
  }
</script>
</body>
</html>
