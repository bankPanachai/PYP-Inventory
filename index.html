<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Crew Gear Requisition</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@400;500;600&display=swap" rel="stylesheet">
  <style>
    body { background-color: #f4f7f9; font-family: 'Sarabun', sans-serif; padding: 15px; }
    .container { max-width: 500px; margin: auto; }
    .card-main { background: white; border-radius: 24px; box-shadow: 0 10px 40px rgba(0,0,0,0.06); padding: 25px; border: none; }
    .item-card { border: 1.5px solid #edf2f7; border-radius: 18px; padding: 16px; margin-bottom: 12px; background: #fff; }
    .item-card.selected { border-color: #3182ce; background-color: #f0f7ff; }
    .item-card.error { border: 2.5px solid #e53e3e !important; background-color: #fff5f5; }
    .staff-row { border: 1px solid #e2e8f0; border-radius: 14px; padding: 15px; margin-bottom: 10px; cursor: pointer; background: white; transition: 0.2s; }
    .staff-row:hover { background-color: #f8fafc; }
    .hidden { display: none; }
    .disabled-input { opacity: 0.4; pointer-events: none; filter: grayscale(1); }
    .role-btn { border: 2px solid #e2e8f0; border-radius: 12px; padding: 15px; text-align: center; cursor: pointer; font-weight: 600; background: white; }
    .role-btn.active { border-color: #3182ce; background-color: #3182ce; color: white; }
    .summary-item { background: #fff; border-left: 4px solid #3182ce; padding: 12px; margin-bottom: 10px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.03); }
  </style>
</head>
<body>

<div class="container">
  <div class="card-main">
    <div id="step1">
      <h5 class="fw-bold mb-4 text-center">ค้นหารายชื่อลูกเรือ</h5>
      <div class="input-group mb-4 shadow-sm">
        <input type="text" id="searchInput" class="form-control p-3 border-0" placeholder="ชื่อ หรือ IPN...">
        <button class="btn btn-primary px-4" onclick="searchCrew()">ค้นหา</button>
      </div>
      <div id="staffList"></div>
    </div>

    <div id="stepConfirmName" class="hidden">
      <h5 class="fw-bold text-center mb-4">ระบุตำแหน่งงาน</h5>
      <div class="p-3 rounded-4 text-center mb-4 bg-light">
        <div class="fs-5 fw-bold text-primary" id="confirmingName"></div>
        <small class="text-muted">IPN: <span id="confirmingIpn"></span></small>
      </div>
      <div class="mb-4">
        <label class="small fw-bold text-muted">ตำแหน่งหลัก</label>
        <select class="form-select form-select-lg" id="rankSelector" onchange="checkSpecialRank()"><option value="">-- เลือกตำแหน่ง --</option></select>
      </div>
      <div id="specialRoleArea" class="hidden mb-4">
        <div class="row g-2">
          <div class="col-6"><div class="role-btn" id="roleBtnNormal" onclick="selectRole('normal')"></div></div>
          <div class="col-6"><div class="role-btn" id="roleBtnMSM" onclick="selectRole('MSM')">Duty MSM</div></div>
        </div>
      </div>
      <button class="btn btn-primary w-100 p-3 shadow fw-bold" onclick="proceedToItems()">ถัดไป</button>
    </div>

    <div id="step2" class="hidden">
      <h5 class="fw-bold mb-4 text-primary">รายการเบิกของ</h5>
      <div id="itemList"></div>
      <button class="btn btn-primary w-100 p-3 mt-4 fw-bold" onclick="goToSummary()">ตรวจสอบสรุปรายการ</button>
    </div>

    <div id="step3" class="hidden">
      <h5 class="fw-bold mb-4 text-center">สรุปรายการ</h5>
      <div id="summaryContent" class="mb-4"></div>
      <button id="btnConfirm" class="btn btn-success w-100 p-3 fw-bold shadow" onclick="confirmSubmit()">ยืนยันบันทึกข้อมูล</button>
      <button class="btn btn-link w-100 text-muted mt-2" onclick="switchStep('step2')">กลับไปแก้ไข</button>
    </div>

    <div id="stepSuccess" class="hidden text-center py-5">
      <div class="display-1 text-success mb-3">✔</div>
      <h4 class="fw-bold">บันทึกเรียบร้อย</h4>
      <button class="btn btn-primary px-5 mt-4" onclick="location.reload()">กลับหน้าแรก</button>
    </div>
  </div>
</div>

<script>
  // เปลี่ยน URL นี้เป็น Web App URL ของคุณ
  const API_URL = "https://script.google.com/macros/s/AKfycbxqlBgaZ2LT5m99FzZkbQW_NMqIFYPp-OiLWwMM86dyw2KTHu4zg_2UnqCSUxBP3Tlv/exec"; 

  let crew = {};
  let selectedDuty = "";
  const shoeMap = { "4": "38", "5": "39", "6": "40", "7": "41", "8": "42", "9": "43", "10": "44", "11": "45", "12": "46" };

  // ฟังก์ชัน API Fetch ที่แก้ปัญหา Redirect ของ Google
  async function apiFetch(params) {
    const url = new URL(API_URL);
    Object.keys(params).forEach(key => url.searchParams.append(key, params[key]));
    
    // สำคัญ: Google จะ Redirect (302) ลิงก์ไปหาหน้าอื่น ต้องใช้ redirect: 'follow'
    const res = await fetch(url.toString(), {
      method: 'GET',
      mode: 'cors',
      redirect: 'follow'
    });
    return await res.json();
  }

  window.onload = async function() {
    try {
      const ranks = await apiFetch({action: 'getRanks'});
      const sel = document.getElementById('rankSelector');
      ranks.forEach(r => {
        let opt = document.createElement('option');
        opt.value = r; opt.innerText = r;
        sel.appendChild(opt);
      });
    } catch(e) { console.error("Error loading ranks:", e); }
  };

  async function searchCrew() {
    const q = document.getElementById('searchInput').value;
    if(!q) return;
    document.getElementById('staffList').innerHTML = '<div class="text-center p-3">กำลังค้นหา...</div>';
    try {
      const res = await apiFetch({action: 'searchStaff', query: q});
      let html = '';
      if(res.data && res.data.length > 0) {
        res.data.forEach(s => {
          html += `<div class="staff-row p-3 shadow-sm mb-2" onclick="showConfirmName('${s.ipn}', '${s.name}')">
                    <div class="fw-bold text-primary">${s.name}</div>
                    <div class="small text-muted">IPN: ${s.ipn}</div>
                  </div>`;
        });
      }
      document.getElementById('staffList').innerHTML = html || '<div class="alert alert-warning">ไม่พบชื่อนี้</div>';
    } catch(e) { 
      console.error(e);
      alert("การค้นหาผิดพลาด: ตรวจสอบการเชื่อมต่ออินเทอร์เน็ต"); 
    }
  }

  function showConfirmName(ipn, name) {
    crew = { ipn, name };
    document.getElementById('confirmingName').innerText = name;
    document.getElementById('confirmingIpn').innerText = ipn;
    switchStep('stepConfirmName');
  }

  function checkSpecialRank() {
    const rank = document.getElementById('rankSelector').value;
    const roleArea = document.getElementById('specialRoleArea');
    if (rank === "OS" || rank === "WPR") {
      roleArea.classList.remove('hidden');
      document.getElementById('roleBtnNormal').innerText = "Duty " + rank;
      document.getElementById('roleBtnNormal').dataset.val = rank;
    } else {
      roleArea.classList.add('hidden');
      selectedDuty = rank;
    }
  }

  function selectRole(type) {
    document.querySelectorAll('.role-btn').forEach(b => b.classList.remove('active'));
    if (type === 'normal') {
      document.getElementById('roleBtnNormal').classList.add('active');
      selectedDuty = document.getElementById('roleBtnNormal').dataset.val;
    } else {
      document.getElementById('roleBtnMSM').classList.add('active');
      selectedDuty = "MSM";
    }
  }

  async function proceedToItems() {
    const mainRank = document.getElementById('rankSelector').value;
    if (!mainRank) return alert("เลือกตำแหน่งก่อน");
    if (!selectedDuty) selectedDuty = mainRank;
    crew.mainRank = mainRank;
    try {
      const items = await apiFetch({action: 'getItems', rank: selectedDuty});
      crew.allowedItems = items;
      renderItems(items);
      switchStep('step2');
    } catch(e) { alert("โหลดรายการไม่สำเร็จ"); }
  }

  function renderItems(items) {
    const list = document.getElementById('itemList');
    list.innerHTML = items.map((item, i) => `
      <div class="item-card p-3 shadow-sm" id="itemBox_${i}">
        <div class="row align-items-center">
          <div class="col-7"><b>${item.name}</b><br><small>Limit: ${item.limit}</small></div>
          <div class="col-5">
            <input type="number" class="form-control text-center" id="qty_${i}" min="0" max="${item.limit}" value="0" oninput="updateItemState(${i})">
          </div>
        </div>
        ${item.sizes.length > 0 ? `
          <select class="form-select mt-2 disabled-input" id="size_${i}">
            <option value="">-- เลือกไซส์ --</option>
            ${item.sizes.map(s => `<option value="${s}">${s} ${shoeMap[s] ? '(EU '+shoeMap[s]+')' : ''}</option>`).join('')}
          </select>` : ''}
      </div>`).join('');
  }

  function updateItemState(i) {
    const qty = parseInt(document.getElementById('qty_'+i).value) || 0;
    const box = document.getElementById('itemBox_'+i);
    const size = document.getElementById('size_'+i);
    if (qty > 0) {
      box.classList.add('selected');
      if(size) size.classList.remove('disabled-input');
    } else {
      box.classList.remove('selected');
      if(size) { size.classList.add('disabled-input'); size.value = ""; }
    }
  }

  function goToSummary() {
    let selected = [];
    let hasError = false;
    crew.allowedItems.forEach((item, i) => {
      const qty = parseInt(document.getElementById('qty_'+i).value) || 0;
      if (qty > 0) {
        const sz = document.getElementById('size_'+i) ? document.getElementById('size_'+i).value : "";
        if (document.getElementById('size_'+i) && !sz) {
          document.getElementById('itemBox_'+i).classList.add('error');
          hasError = true;
        } else {
          selected.push({ itemName: item.name, qty, size: sz ? sz + (shoeMap[sz] ? ' (EU '+shoeMap[sz]+')' : '') : 'N/A' });
        }
      }
    });
    if(hasError) return alert("กรุณาเลือกไซส์ให้ครบ");
    if(selected.length === 0) return alert("เลือกของอย่างน้อย 1 อย่าง");
    crew.selected = selected;
    document.getElementById('summaryContent').innerHTML = selected.map(s => `<div class="summary-item"><b>${s.itemName}</b> x ${s.qty} <br><small>Size: ${s.size}</small></div>`).join('');
    switchStep('step3');
  }

  async function confirmSubmit() {
    const btn = document.getElementById('btnConfirm');
    btn.disabled = true; btn.innerText = "กำลังบันทึก...";
    try {
      // ใช้ no-cors สำหรับส่งข้อมูล POST ป้องกันปัญหา Preflight (OPTIONS)
      await fetch(API_URL, {
        method: 'POST',
        mode: 'no-cors',
        body: JSON.stringify({ ipn: crew.ipn, name: crew.name, rank: crew.mainRank, items: crew.selected })
      });
      switchStep('stepSuccess');
    } catch(e) { 
      alert("บันทึกไม่สำเร็จ"); 
      btn.disabled = false; 
      btn.innerText = "ยืนยันบันทึกข้อมูล";
    }
  }

  function switchStep(id) {
    ['step1', 'stepConfirmName', 'step2', 'step3', 'stepSuccess'].forEach(s => document.getElementById(s).classList.add('hidden'));
    document.getElementById(id).classList.remove('hidden');
    window.scrollTo(0,0);
  }
</script>
</body>
</html>
