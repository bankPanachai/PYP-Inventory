<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Crew Gear Requisition</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@400;500;600&display=swap" rel="stylesheet">
  <style>
    body { background-color: #f4f7f9; font-family: 'Sarabun', sans-serif; padding: 15px; }
    .container { max-width: 500px; margin: auto; }
    .card-main { background: white; border-radius: 24px; box-shadow: 0 10px 30px rgba(0,0,0,0.08); padding: 25px; border: none; }
    .item-card { border: 1.5px solid #edf2f7; border-radius: 18px; padding: 16px; margin-bottom: 12px; background: #fff; }
    .item-card.selected { border-color: #3182ce; background-color: #f0f7ff; }
    .item-card.error { border: 2.5px solid #e53e3e !important; background-color: #fff5f5; }
    .hidden { display: none; }
    .disabled-input { opacity: 0.4; pointer-events: none; }
    .role-btn { border: 2px solid #e2e8f0; border-radius: 12px; padding: 15px; text-align: center; cursor: pointer; font-weight: 600; background: #fff; }
    .role-btn.active { border-color: #3182ce; background-color: #3182ce; color: white; }
  </style>
</head>
<body>

<div class="container">
  <div class="card-main shadow-sm" id="app">
    <div id="step1">
      <h5 class="fw-bold mb-4 text-center">ค้นหารายชื่อลูกเรือ</h5>
      <div class="input-group mb-4">
        <input type="text" id="searchInput" class="form-control p-3" placeholder="ชื่อ หรือ IPN...">
        <button class="btn btn-primary" onclick="searchCrew()">ค้นหา</button>
      </div>
      <div id="staffList"></div>
    </div>

    <div id="stepConfirmName" class="hidden">
      <h5 class="fw-bold text-center mb-4">ระบุตำแหน่ง</h5>
      <div class="p-3 rounded-4 text-center mb-4 bg-light">
        <div class="fs-5 fw-bold text-primary" id="confirmingName"></div>
        <small class="text-muted">IPN: <span id="confirmingIpn"></span></small>
      </div>
      <select class="form-select form-select-lg mb-4" id="rankSelector" onchange="checkSpecialRank()">
        <option value="">-- เลือกตำแหน่ง --</option>
      </select>
      <div id="specialRoleArea" class="hidden mb-4">
        <div class="row g-2">
          <div class="col-6"><div class="role-btn" id="roleBtnNormal" onclick="selectRole('normal')"></div></div>
          <div class="col-6"><div class="role-btn" id="roleBtnMSM" onclick="selectRole('MSM')">Duty MSM</div></div>
        </div>
      </div>
      <button class="btn btn-primary w-100 p-3" onclick="proceedToItems()">ถัดไป</button>
    </div>

    <div id="step2" class="hidden">
      <h5 class="fw-bold mb-4 text-primary">รายการเบิกของ</h5>
      <div id="itemList"></div>
      <button class="btn btn-primary w-100 p-3 mt-4" onclick="goToSummary()">สรุปรายการ</button>
    </div>

    <div id="step3" class="hidden">
      <h5 class="fw-bold mb-4 text-center">ยืนยันรายการ</h5>
      <div id="summaryContent" class="mb-4"></div>
      <button id="btnConfirm" class="btn btn-success w-100 p-3" onclick="confirmSubmit()">ยืนยันบันทึกข้อมูล</button>
    </div>

    <div id="stepSuccess" class="hidden text-center py-5">
      <div class="display-1 text-success">✔</div>
      <h4>บันทึกเรียบร้อย</h4>
      <button class="btn btn-primary mt-3" onclick="location.reload()">กลับหน้าแรก</button>
    </div>
  </div>
</div>

<script>
  // วาง URL ของ Google Apps Script ที่ได้จาก Deployment ที่นี่
  const API_URL = 'วาล_WEB_APP_URL_ที่นี่';
  
  let crew = {};
  let selectedDuty = "";
  const shoeMap = { "4": "38", "5": "39", "6": "40", "7": "41", "8": "42", "9": "43", "10": "44", "11": "45", "12": "46" };

  async function callAPI(params, body = null) {
    const url = new URL(API_URL);
    Object.keys(params).forEach(key => url.searchParams.append(key, params[key]));
    
    const options = { method: body ? 'POST' : 'GET' };
    if (body) options.body = JSON.stringify(body);
    
    const response = await fetch(url);
    return await response.json();
  }

  window.onload = async () => {
    const ranks = await callAPI({action: 'getRanks'});
    const sel = document.getElementById('rankSelector');
    ranks.forEach(r => {
      let opt = document.createElement('option');
      opt.value = r; opt.innerText = r;
      sel.appendChild(opt);
    });
  };

  async function searchStaffList(query) {
    // แก้ไขปัญหา CORS เบื้องต้นด้วยการส่งแบบ GET พารามิเตอร์ หรือใช้ Proxy ถ้าจำเป็น
    // สำหรับ Google Script 'Anyone' ปกติจะ Fetch ได้โดยตรง
    const res = await fetch(`${API_URL}?action=searchStaff&query=${query}`);
    return await res.json();
  }

  async function searchCrew() {
    const q = document.getElementById('searchInput').value;
    const res = await searchStaffList(q);
    let html = '';
    res.data.forEach(s => {
      html += `<div class="staff-row" onclick="showConfirmName('${s.ipn}', '${s.name}')">${s.name} (IPN: ${s.ipn})</div>`;
    });
    document.getElementById('staffList').innerHTML = html;
  }

  function showConfirmName(ipn, name) {
    crew = { ipn, name };
    document.getElementById('confirmingName').innerText = name;
    document.getElementById('confirmingIpn').innerText = ipn;
    switchStep('stepConfirmName');
  }

  function checkSpecialRank() {
    const rank = document.getElementById('rankSelector').value;
    if (rank === "OS" || rank === "WPR") {
      document.getElementById('specialRoleArea').classList.remove('hidden');
      document.getElementById('roleBtnNormal').innerText = "Duty " + rank;
      document.getElementById('roleBtnNormal').dataset.val = rank;
    } else {
      document.getElementById('specialRoleArea').classList.add('hidden');
      selectedDuty = rank;
    }
  }

  function selectRole(type) {
    document.querySelectorAll('.role-btn').forEach(b => b.classList.remove('active'));
    if (type === 'normal') {
      document.getElementById('roleBtnNormal').classList.add('active');
      selectedDuty = document.getElementById('roleBtnNormal').dataset.val;
    } else {
      document.getElementById('roleBtnMSM').classList.add('active');
      selectedDuty = "MSM";
    }
  }

  async function proceedToItems() {
    const mainRank = document.getElementById('rankSelector').value;
    if (!selectedDuty) selectedDuty = mainRank;
    crew.mainRank = mainRank;
    const res = await fetch(`${API_URL}?action=getItems&rank=${selectedDuty}`);
    const items = await res.json();
    crew.allowedItems = items;
    renderItems(items);
    switchStep('step2');
  }

  function renderItems(items) {
    const list = document.getElementById('itemList');
    list.innerHTML = items.map((item, i) => `
      <div class="item-card" id="itemBox_${i}">
        <div class="d-flex justify-content-between">
          <span>${item.name} (Max: ${item.limit})</span>
          <input type="number" id="qty_${i}" class="form-control w-25" value="0" oninput="updateItemState(${i})">
        </div>
        ${item.sizes.length > 0 ? `
          <select id="size_${i}" class="form-select mt-2 disabled-input">
            <option value="">-- ไซส์ --</option>
            ${item.sizes.map(s => `<option value="${s}">${s} ${shoeMap[s] ? '(EU '+shoeMap[s]+')' : ''}</option>`).join('')}
          </select>` : ''}
      </div>`).join('');
  }

  function updateItemState(i) {
    const qty = document.getElementById('qty_'+i).value;
    const box = document.getElementById('itemBox_'+i);
    const size = document.getElementById('size_'+i);
    if (qty > 0) {
      box.classList.add('selected');
      if(size) size.classList.remove('disabled-input');
    } else {
      box.classList.remove('selected');
      if(size) size.classList.add('disabled-input');
    }
  }

  function goToSummary() {
    let selected = [];
    let err = false;
    crew.allowedItems.forEach((item, i) => {
      const qty = parseInt(document.getElementById('qty_'+i).value);
      if(qty > 0) {
        const size = document.getElementById('size_'+i) ? document.getElementById('size_'+i).value : "";
        if(document.getElementById('size_'+i) && !size) {
          document.getElementById('itemBox_'+i).classList.add('error');
          err = true;
        }
        selected.push({ itemName: item.name, qty, size });
      }
    });
    if(err) return alert("กรุณาเลือกไซส์");
    crew.selected = selected;
    document.getElementById('summaryContent').innerHTML = selected.map(s => `<div>${s.itemName} x ${s.qty} ${s.size}</div>`).join('');
    switchStep('step3');
  }

  async function confirmSubmit() {
    const btn = document.getElementById('btnConfirm');
    btn.disabled = true;
    const response = await fetch(`${API_URL}?action=submit`, {
      method: 'POST',
      body: JSON.stringify({
        ipn: crew.ipn,
        name: crew.name,
        rank: crew.mainRank,
        items: crew.selected
      })
    });
    const res = await response.json();
    if(res === "Success") switchStep('stepSuccess');
  }

  function switchStep(id) {
    ['step1', 'stepConfirmName', 'step2', 'step3', 'stepSuccess'].forEach(s => document.getElementById(s).classList.add('hidden'));
    document.getElementById(id).classList.remove('hidden');
  }
</script>
</body>
</html>