<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Crew Gear System</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@400;600;800&display=swap" rel="stylesheet">
  <style>
    :root { --primary: #2563eb; --bg: #f8fafc; }
    body { background-color: var(--bg); font-family: 'Sarabun', sans-serif; -webkit-tap-highlight-color: transparent; }
    .card-main { background: white; border-radius: 20px; box-shadow: 0 4px 25px rgba(0,0,0,0.1); padding: 25px; border: none; margin-top: 20px; position: relative; }
    
    .qty-box { display: flex; align-items: center; justify-content: center; gap: 12px; }
    .btn-step { width: 45px; height: 45px; border-radius: 12px; border: 1px solid #ddd; background: #fff; font-size: 24px; font-weight: bold; display: flex; align-items: center; justify-content: center; user-select: none; cursor: pointer; }
    .btn-step:active { background: #f1f5f9; transform: scale(0.9); }
    .qty-val { font-size: 22px; font-weight: 800; min-width: 35px; text-align: center; }

    .item-card { border: 1.5px solid #e2e8f0; border-radius: 16px; padding: 18px; margin-bottom: 15px; transition: 0.3s; }
    .item-card.has-val { border-color: var(--primary); background-color: #eff6ff; }
    .item-card.error { border-color: #ef4444; background: #fef2f2; }

    .staff-row { border: 1px solid #e2e8f0; border-radius: 12px; padding: 15px; margin-bottom: 10px; cursor: pointer; background: #fff; box-shadow: 0 2px 4px rgba(0,0,0,0.02); }
    .staff-row:active { background: #f8fafc; }
    
    .role-btn { border: 2px solid #e2e8f0; border-radius: 15px; padding: 15px; text-align: center; cursor: pointer; font-weight: 800; background: white; transition: 0.2s; }
    .role-btn.active { border-color: var(--primary); background-color: var(--primary); color: white; }
    
    .hidden { display: none; }
    .btn-main { border-radius: 15px; padding: 16px; font-weight: 800; font-size: 18px; }
    .summary-item { background: #f8fafc; border-left: 5px solid var(--primary); padding: 12px; margin-bottom: 10px; border-radius: 8px; font-size: 15px; }
    .profile-banner { background: #f1f5f9; border-radius: 15px; padding: 15px; border: 1px dashed #cbd5e1; }
  </style>
</head>
<body>

<div class="container" style="max-width: 500px; padding-bottom: 50px;">
  <div class="card-main">
    
    <div id="step1">
      <h4 class="fw-bold mb-3 text-center">üö¢ ‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏ö‡∏¥‡∏Å‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏Ñ‡∏ô‡πÄ‡∏£‡∏∑‡∏≠</h4>
      <div class="input-group mb-4 shadow-sm" style="border-radius: 15px; overflow: hidden;">
        <input type="text" id="searchInput" class="form-control p-3 border-0" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ä‡∏∑‡πà‡∏≠‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏•‡∏Ç IPN...">
        <button class="btn btn-primary px-4" onclick="searchCrew()">‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤</button>
      </div>
      <div id="staffList"></div>
    </div>

    <div id="stepConfirmName" class="hidden">
      <div class="mb-3"><button class="btn btn-sm btn-outline-secondary" onclick="switchStep('step1')">‚Üê ‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö</button></div>
      <h5 class="fw-bold text-center mb-4">‡∏£‡∏∞‡∏ö‡∏∏‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô</h5>
      <div class="profile-banner text-center mb-4 shadow-sm">
        <div class="fs-4 fw-bold text-primary" id="confirmingName"></div>
        <div class="text-muted">IPN: <span id="confirmingIpn"></span></div>
      </div>
      
      <div class="mb-4">
        <label class="fw-bold mb-2 small text-muted">‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏´‡∏•‡∏±‡∏Å (Rank)</label>
        <select class="form-select form-select-lg" id="rankSelector" onchange="checkSpecialRank()" style="border-radius: 12px;"></select>
      </div>

      <div id="specialRoleArea" class="hidden mb-4">
        <label class="fw-bold mb-2 small text-muted">‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏á‡∏≤‡∏ô (Duty)</label>
        <div class="row g-2">
          <div class="col-6"><div class="role-btn" id="roleBtnNormal" onclick="selectRole('normal')"></div></div>
          <div class="col-6"><div class="role-btn" id="roleBtnMSM" onclick="selectRole('MSM')">Duty MSM</div></div>
        </div>
      </div>
      <button class="btn btn-primary w-100 btn-main shadow" onclick="proceedToItems()">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏ö‡∏¥‡∏Å ‚Üí</button>
    </div>

    <div id="step2" class="hidden">
      <div class="mb-3"><button class="btn btn-sm btn-outline-secondary" onclick="switchStep('stepConfirmName')">‚Üê ‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö</button></div>
      <h5 class="fw-bold mb-4 text-primary text-center">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏ó‡∏µ‡πà‡πÄ‡∏ö‡∏¥‡∏Å‡πÑ‡∏î‡πâ</h5>
      <div id="itemList"></div>
      <button class="btn btn-primary w-100 btn-main mt-3 shadow" onclick="goToSummary()">‡∏î‡∏π‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏•‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</button>
    </div>

    <div id="step3" class="hidden">
      <div class="mb-3"><button class="btn btn-sm btn-outline-secondary" onclick="switchStep('step2')">‚Üê ‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö</button></div>
      <h5 class="fw-bold mb-4 text-center">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏ö‡∏¥‡∏Å</h5>
      
      <div class="profile-banner mb-4">
        <div class="fw-bold text-primary" id="sumCrewName"></div>
        <div class="small">IPN: <span id="sumCrewIpn"></span> | Rank: <span id="sumCrewRank"></span></div>
      </div>

      <div id="summaryContent" class="mb-4"></div>
      <button id="btnConfirm" class="btn btn-success w-100 btn-main shadow mb-2" onclick="confirmSubmit()">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
    </div>

    <div id="stepSuccess" class="hidden text-center py-5">
      <div class="display-1 text-success mb-3">‚úî</div>
      <h4 class="fw-bold">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢</h4>
      <p class="text-muted">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ñ‡∏π‡∏Å‡∏™‡πà‡∏á‡πÄ‡∏Ç‡πâ‡∏≤ Excel ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß</p>
      <button class="btn btn-primary btn-main px-5 mt-3 shadow" onclick="location.reload()">‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏£‡∏Å</button>
    </div>

  </div>
</div>

<script>
  // ** ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô URL ‡πÄ‡∏õ‡πá‡∏ô‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì **
  const API_URL = "https://script.google.com/macros/s/AKfycby_ew85FsiIme__rpZ4cI61p55O7qTKvqOCqZsrc7jHYAK5Oqw59elOtx32FPO624ZH0A/exec"; 

  let crew = {};
  let selectedDuty = "";
  let itemsData = [];
  const shoeMap = { "4": "38", "5": "39", "6": "40", "7": "41", "8": "42", "9": "43", "10": "44", "11": "45", "12": "46" };

  function apiFetch(params) {
    return new Promise((resolve, reject) => {
      const callbackName = 'jsonp_' + Math.round(100000 * Math.random());
      window[callbackName] = function(data) {
        delete window[callbackName];
        document.body.removeChild(script);
        resolve(data);
      };
      const url = new URL(API_URL);
      Object.keys(params).forEach(key => url.searchParams.append(key, params[key]));
      url.searchParams.append('callback', callbackName);
      const script = document.createElement('script');
      script.src = url.toString();
      script.onerror = () => reject(new Error('Network Error'));
      document.body.appendChild(script);
    });
  }

  window.onload = async () => {
    try {
      const ranks = await apiFetch({action: 'getRanks'});
      const sel = document.getElementById('rankSelector');
      sel.innerHTML = '<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á --</option>';
      ranks.forEach(r => sel.innerHTML += `<option value="${r}">${r}</option>`);
    } catch(e) { console.error(e); }
  };

  async function searchCrew() {
    const q = document.getElementById('searchInput').value;
    if(!q) return;
    document.getElementById('staffList').innerHTML = '<div class="text-center p-4 text-muted">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤...</div>';
    try {
      const res = await apiFetch({action: 'searchStaff', query: q});
      let html = '';
      res.data.forEach(s => {
        html += `<div class="staff-row" onclick="showConfirmName('${s.ipn}', '${s.name}')">
                  <div class="fw-bold text-primary">${s.name}</div>
                  <div class="small text-muted">IPN: ${s.ipn}</div>
                </div>`;
      });
      document.getElementById('staffList').innerHTML = html || '<div class="p-3 text-center">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠</div>';
    } catch(e) { alert("Error"); }
  }

  function showConfirmName(ipn, name) {
    crew = { ipn, name };
    document.getElementById('confirmingName').innerText = name;
    document.getElementById('confirmingIpn').innerText = ipn;
    switchStep('stepConfirmName');
  }

  function checkSpecialRank() {
    const r = document.getElementById('rankSelector').value;
    const area = document.getElementById('specialRoleArea');
    if (r === "OS" || r === "WPR") {
      area.classList.remove('hidden');
      document.getElementById('roleBtnNormal').innerText = "Duty " + r;
      document.getElementById('roleBtnNormal').dataset.val = r;
    } else {
      area.classList.add('hidden');
      selectedDuty = r;
    }
  }

  function selectRole(t) {
    document.querySelectorAll('.role-btn').forEach(b => b.classList.remove('active'));
    if (t === 'normal') {
      document.getElementById('roleBtnNormal').classList.add('active');
      selectedDuty = document.getElementById('roleBtnNormal').dataset.val;
    } else {
      document.getElementById('roleBtnMSM').classList.add('active');
      selectedDuty = "MSM";
    }
  }

  async function proceedToItems() {
    const rankVal = document.getElementById('rankSelector').value;
    if (!rankVal) return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á");
    if (!selectedDuty) selectedDuty = rankVal;
    crew.mainRank = rankVal;
    try {
      itemsData = await apiFetch({action: 'getItems', rank: selectedDuty});
      renderItems();
      switchStep('step2');
    } catch(e) { alert("‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß"); }
  }

  function renderItems() {
    const list = document.getElementById('itemList');
    list.innerHTML = itemsData.map((item, i) => `
      <div class="item-card shadow-sm" id="itemBox_${i}">
        <div class="d-flex justify-content-between align-items-center mb-2">
          <div><div class="fw-bold">${item.name}</div><small class="text-muted">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏ö‡∏¥‡∏Å‡πÑ‡∏î‡πâ‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î: ${item.limit}</small></div>
          <div class="qty-box">
            <div class="btn-step" onclick="changeQty(${i}, -1)">-</div>
            <div class="qty-val" id="qtext_${i}">0</div>
            <div class="btn-step" onclick="changeQty(${i}, 1)">+</div>
          </div>
        </div>
        ${item.sizes.length > 0 ? `
          <select class="form-select mt-2 hidden" id="size_${i}" style="border-radius:10px;">
            <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ã‡∏™‡πå --</option>
            ${item.sizes.map(s => `<option value="${s}">${s} ${shoeMap[s] ? '(EU '+shoeMap[s]+')' : ''}</option>`).join('')}
          </select>` : ''}
      </div>`).join('');
  }

  function changeQty(i, delta) {
    const textObj = document.getElementById('qtext_'+i);
    let val = parseInt(textObj.innerText) + delta;
    if (val < 0) val = 0;
    if (val > itemsData[i].limit) val = itemsData[i].limit;
    textObj.innerText = val;
    
    const box = document.getElementById('itemBox_'+i);
    const sizeSel = document.getElementById('size_'+i);
    if (val > 0) {
      box.classList.add('has-val');
      if(sizeSel) sizeSel.classList.remove('hidden');
    } else {
      box.classList.remove('has-val');
      if(sizeSel) { sizeSel.classList.add('hidden'); sizeSel.value = ""; }
    }
  }

  function goToSummary() {
    let sel = [];
    let err = false;
    itemsData.forEach((item, i) => {
      const q = parseInt(document.getElementById('qtext_'+i).innerText);
      if (q > 0) {
        const sz = document.getElementById('size_'+i) ? document.getElementById('size_'+i).value : "";
        if (document.getElementById('size_'+i) && !sz) {
          document.getElementById('itemBox_'+i).classList.add('error');
          err = true;
        } else {
          document.getElementById('itemBox_'+i).classList.remove('error');
          const sizeLabel = sz + (shoeMap[sz] ? ` (EU ${shoeMap[sz]})` : "");
          sel.push({ itemName: item.name, qty: q, size: sizeLabel });
        }
      }
    });
    if(err) return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ã‡∏™‡πå‡∏Ç‡∏≠‡∏á‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏î‡πâ‡∏ß‡∏¢‡∏Ñ‡∏£‡∏±‡∏ö");
    
    crew.selected = sel;
    document.getElementById('sumCrewName').innerText = crew.name;
    document.getElementById('sumCrewIpn').innerText = crew.ipn;
    document.getElementById('sumCrewRank').innerText = crew.mainRank;

    let html = sel.map(s => `<div class="summary-item"><b>${s.itemName}</b> <span class="float-end">x${s.qty} <small>(${s.size})</small></span></div>`).join('');
    document.getElementById('summaryContent').innerHTML = html || '<div class="alert alert-secondary text-center fw-bold">‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏î‡πÜ<br>(‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ß‡πà‡∏≤‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏ö‡∏Ç‡∏≠‡∏á)</div>';
    switchStep('step3');
  }

  async function confirmSubmit() {
    const btn = document.getElementById('btnConfirm');
    btn.disabled = true; btn.innerText = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...";
    try {
      await fetch(API_URL, {
        method: 'POST',
        mode: 'no-cors',
        body: JSON.stringify({ ipn: crew.ipn, name: crew.name, rank: crew.mainRank, items: crew.selected })
      });
      switchStep('stepSuccess');
    } catch(e) { 
      alert("‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î"); btn.disabled = false; btn.innerText = "‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•";
    }
  }

  function switchStep(id) {
    ['step1', 'stepConfirmName', 'step2', 'step3', 'stepSuccess'].forEach(s => document.getElementById(s).classList.add('hidden'));
    document.getElementById(id).classList.remove('hidden');
    window.scrollTo(0,0);
  }
</script>
</body>
</html>
